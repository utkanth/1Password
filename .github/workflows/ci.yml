name: CI with 1Password Secrets Automation for Interview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # allows manual "Run workflow" button

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        run: |
          echo "üîß Installing 1Password CLI..."
          curl -fsSL https://downloads.1password.com/linux/keys/1password.asc | sudo tee /etc/apt/trusted.gpg.d/1password.asc
          echo "deb [arch=amd64] https://downloads.1password.com/linux/debian stable main" | sudo tee /etc/apt/sources.list.d/1password.list
          sudo apt update
          sudo apt install -y op
          echo "‚úÖ 1Password CLI installed successfully."

      - name: Verify 1Password CLI installation
        run: |
          op --version
          echo "‚úÖ Verified that 1Password CLI is available."

      - name: Retrieve secrets from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "üîê Fetching secrets from 1Password..."
          API_KEY=$(op read "op://demo-ci-secrets/API_KEY")
          DEPLOY_TOKEN=$(op read "op://demo-ci-secrets/DEPLOY_TOKEN")
          echo "::add-mask::$API_KEY"
          echo "::add-mask::$DEPLOY_TOKEN"
          echo "‚úÖ Secrets fetched successfully."

      - name: Use the secret in a simulated build step
        run: |
          echo "üöÄ Using secrets in a simulated build..."
          echo "Connecting to database with secure credentials..."
          echo "‚úÖ Build simulation complete."

      - name: Run workflow manually confirmation
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üßë‚Äçüíª Workflow triggered manually via the 'Run workflow' button."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
