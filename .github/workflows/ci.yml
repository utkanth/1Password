name: CI with 1Password Secrets Automation for Interview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # allows manual trigger for demo

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y unzip curl jq

      - name: Install 1Password CLI (direct download)
        run: |
          curl -sSL https://cache.agilebits.com/dist/1P/op2/pkg/v2.30.3/op_linux_amd64_v2.30.3.zip -o op.zip
          unzip -q op.zip
          sudo mv op /usr/local/bin/
          op --version

      - name: 1Password Secrets Operations
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "ğŸ” Authenticating using OP_SERVICE_ACCOUNT_TOKEN..."
          
          ITEM_TO_UPDATE="API_KEY"
          VAULT="1password PoC"
          DEPLOY_TOKEN_ITEM="DEPLOY_TOKEN"
          TEMP_ITEM_TO_KEEP="CI_TEMP_LOGIN"

          # ----------------------------------------------------------------------
          # --- 1. READ/FETCH SECRETS ---
          # ----------------------------------------------------------------------
          echo "ğŸ“– Reading from Vault..."
          
          API_KEY_CURRENT_VALUE=$(op read "op://${VAULT}/${ITEM_TO_UPDATE}/username")
          DEPLOY_TOKEN_VALUE=$(op read "op://${VAULT}/${DEPLOY_TOKEN_ITEM}/username")

          echo "â€¢ API_KEY: ${API_KEY_CURRENT_VALUE:0:10}..."
          echo "â€¢ DEPLOY_TOKEN: ${DEPLOY_TOKEN_VALUE:0:10}..."

          # ----------------------------------------------------------------------
          # --- 2. CREATE NEW SECRET ---
          # ----------------------------------------------------------------------
          echo "âœï¸ Writing into Vault..."
          
          NEW_PASSWORD="ci_secret_$(date +%s)"
          op item create --vault "${VAULT}" - >/dev/null 2>&1 << EOF
          {
            "title": "${TEMP_ITEM_TO_KEEP}",
            "category": "LOGIN",
            "fields": [
              {"id": "username", "value": "ci_runner_user"},
              {"id": "password", "value": "${NEW_PASSWORD}"}
            ]
          }
          EOF
          echo "â€¢ Created item: ${TEMP_ITEM_TO_KEEP}"

          # ----------------------------------------------------------------------
          # --- 3. UPDATE EXISTING SECRET ---
          # ----------------------------------------------------------------------
          echo "ğŸ”„ Updating in Vault..."
          
          TODAYS_DATE=$(date +%Y-%m-%d)
          BASE_API_KEY_VALUE=$(echo "$API_KEY_CURRENT_VALUE" | sed 's/_[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$//')
          NEW_API_KEY_VALUE="${BASE_API_KEY_VALUE}_${TODAYS_DATE}"

          CURRENT_JSON=$(op item get "${ITEM_TO_UPDATE}" --vault "${VAULT}" --format json)
          UPDATED_JSON=$(echo "${CURRENT_JSON}" | jq \
            --arg new_val "$NEW_API_KEY_VALUE" \
            '.fields |= map(if .id == "username" then .value = $new_val else . end)')

          echo "${UPDATED_JSON}" | op item edit "${ITEM_TO_UPDATE}" --vault "${VAULT}" - >/dev/null 2>&1
          echo "â€¢ Updated ${ITEM_TO_UPDATE} â†’ ${NEW_API_KEY_VALUE}"

          # ----------------------------------------------------------------------
          # --- 4. DELETE EXISTING SECRET ---
          # ----------------------------------------------------------------------
          echo "ğŸ”¥ Deleting from Vault..."
          
          printf 'y\n' | op item delete "${DEPLOY_TOKEN_ITEM}" --vault "${VAULT}" >/dev/null 2>&1 || true
          echo "â€¢ Deleted item: ${DEPLOY_TOKEN_ITEM}"

      - name: Manual trigger confirmation
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: echo "ğŸ§‘â€ğŸ’» Workflow triggered manually via the 'Run workflow' button."
