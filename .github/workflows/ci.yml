name: CI with 1Password Secrets Automation for Interview

on:
  push:
    branches: [ main ]
  workflow_dispatch: # allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y unzip curl

      - name: Install 1Password CLI (direct download)
        run: |
          echo "üîß Downloading and installing 1Password CLI..."
          curl -sSL https://cache.agilebits.com/dist/1P/op2/pkg/v2.30.3/op_linux_amd64_v2.30.3.zip -o op.zip
          unzip -q op.zip
          sudo mv op /usr/local/bin/
          op --version
          echo "‚úÖ 1Password CLI installed successfully."

      - name: Sign in and fetch secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "üîê Signing in and fetching secrets..."
          
          # Sign in with the service account token
          export OP_SESSION_token=$(op signin --account utkanth.1password.com --raw)
          echo "‚úÖ Signed in successfully."

          # Fetch secrets
          API_KEY=$(op read "op://1Password PoC/API_KEY/username")
          DEPLOY_TOKEN=$(op read "op://1Password PoC/DEPLOY_TOKEN/username")
      
          # Mask secrets in logs
          echo "::add-mask::$API_KEY"
          echo "::add-mask::$DEPLOY_TOKEN"
      
          # Indicating that these are masked
          echo "üîí The following secrets are **masked** in the logs:"
          echo "API_KEY: ***masked***"
          echo "DEPLOY_TOKEN: ***masked***"
          
          echo "‚úÖ Secrets fetched and masked successfully."

      - name: Use secrets in a simulated build step
        run: |
          echo "üöÄ Using secrets in a simulated build..."
          echo "Connecting to database with secure credentials..."
          echo "‚úÖ Build simulation complete."

      - name: Manual trigger confirmation
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üßë‚Äçüíª Workflow triggered manually via the 'Run workflow' button."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
