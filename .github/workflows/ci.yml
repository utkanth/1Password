name: CI with 1Password Secrets Automation for Interview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # allows manual trigger for demo

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y unzip curl

      - name: Install 1Password CLI (direct download)
        run: |
          echo "üîß Downloading and installing 1Password CLI..."
          curl -sSL https://cache.agilebits.com/dist/1P/op2/pkg/v2.30.3/op_linux_amd64_v2.30.3.zip -o op.zip
          unzip -q op.zip
          sudo mv op /usr/local/bin/
          op --version
          echo "‚úÖ 1Password CLI installed successfully."

      - name: Sign in, fetch and write secrets to 1Password (same session)
        env:
          # Authentication is handled implicitly by the presence of this token.
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "üîê Authenticating using OP_SERVICE_ACCOUNT_TOKEN..."

          # --- READ/FETCH SECRETS (Already Correct) ---
          echo "üîê Fetching secrets..."
          API_KEY=$(op read "op://1password PoC/API_KEY/username")
          DEPLOY_TOKEN=$(op read "op://1password PoC/DEPLOY_TOKEN/username")
          echo "API_KEY: $API_KEY"
          echo "DEPLOY_TOKEN: $DEPLOY_TOKEN"
          echo "‚úÖ Secrets fetched successfully."
          
          # ----------------------------------------------------------------------
          # --- WRITE/CREATE NEW SECRET (Using correct positional assignment) ---
          # ----------------------------------------------------------------------
          echo "‚ú® Creating a new 'CI_TEMP_LOGIN' item using positional assignments..."
          # Use positional assignments: FieldLabel=Value. 
          # Note: The CLI uses 'username' and 'password' as the field labels for a 'login' category.
          op item create \
            --vault "1password PoC" \
            --category login \
            --title "CI_TEMP_LOGIN" \
            "username=ci_runner_user" \
            "password=temp_secret_$(date +%s)" # Note the use of "password" as the field label
            
          echo "‚úÖ New secret 'CI_TEMP_LOGIN' created successfully."
          
          # ----------------------------------------------------------------------
          # --- EDIT/UPDATE EXISTING SECRET (Using correct positional assignment) ---
          # ----------------------------------------------------------------------
          echo "‚úèÔ∏è Updating the 'CI_TEMP_LOGIN' item..."
          # Update the item using the same FieldLabel=Value format.
          op item edit "CI_TEMP_LOGIN" \
            --vault "1password PoC" \
            "username=updated_user_$(date +%s)" \
            --tags ci-updated,demo
            
          echo "‚úÖ Secret 'CI_TEMP_LOGIN' updated successfully."

      - name: Manual trigger confirmation
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üßë‚Äçüíª Workflow triggered manually via the 'Run workflow' button."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
